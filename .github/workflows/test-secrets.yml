name: Test GitHub Secrets

on:
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Secrets Availability
        run: |
          echo "========================================="
          echo "GitHub Secrets æµ‹è¯•"
          echo "========================================="
          echo ""
          echo "ä»“åº“ä¿¡æ¯:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Event: ${{ github.event_name }}"
          echo "  Actor: ${{ github.actor }}"
          echo ""
          echo "========================================="
          echo "Secrets å¯ç”¨æ€§æ£€æŸ¥"
          echo "========================================="
          
          # æ£€æŸ¥æ¯ä¸ª secret æ˜¯å¦å­˜åœ¨ï¼ˆä¸æ˜¾ç¤ºå…·ä½“å€¼ï¼‰
          if [ -n "${{ secrets.REMOTE_HOST }}" ]; then
            echo "âœ… REMOTE_HOST: å·²é…ç½® (é•¿åº¦: ${#REMOTE_HOST})"
          else
            echo "âŒ REMOTE_HOST: æœªé…ç½®æˆ–ä¸ºç©º"
          fi
          
          if [ -n "${{ secrets.REMOTE_USER }}" ]; then
            echo "âœ… REMOTE_USER: å·²é…ç½®"
          else
            echo "âŒ REMOTE_USER: æœªé…ç½®æˆ–ä¸ºç©º"
          fi
          
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            KEY_LENGTH=$(echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -c)
            echo "âœ… SSH_PRIVATE_KEY: å·²é…ç½® (é•¿åº¦: $KEY_LENGTH å­—ç¬¦)"
          else
            echo "âŒ SSH_PRIVATE_KEY: æœªé…ç½®æˆ–ä¸ºç©º"
          fi
          
          if [ -n "${{ secrets.REMOTE_PORT }}" ]; then
            echo "âœ… REMOTE_PORT: å·²é…ç½®"
          else
            echo "âš ï¸  REMOTE_PORT: æœªé…ç½® (å°†ä½¿ç”¨é»˜è®¤å€¼ 22)"
          fi
          
          if [ -n "${{ secrets.REMOTE_FRONTEND_DIR }}" ]; then
            echo "âœ… REMOTE_FRONTEND_DIR: å·²é…ç½®"
          else
            echo "âŒ REMOTE_FRONTEND_DIR: æœªé…ç½®æˆ–ä¸ºç©º"
          fi
          
          if [ -n "${{ secrets.REMOTE_BACKEND_DIR }}" ]; then
            echo "âœ… REMOTE_BACKEND_DIR: å·²é…ç½®"
          else
            echo "âŒ REMOTE_BACKEND_DIR: æœªé…ç½®æˆ–ä¸ºç©º"
          fi
          
          echo ""
          echo "========================================="
          
          # ç»Ÿè®¡ç»“æœ
          MISSING_COUNT=0
          
          [ -z "${{ secrets.REMOTE_HOST }}" ] && ((MISSING_COUNT++))
          [ -z "${{ secrets.REMOTE_USER }}" ] && ((MISSING_COUNT++))
          [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] && ((MISSING_COUNT++))
          [ -z "${{ secrets.REMOTE_FRONTEND_DIR }}" ] && ((MISSING_COUNT++))
          [ -z "${{ secrets.REMOTE_BACKEND_DIR }}" ] && ((MISSING_COUNT++))
          
          if [ $MISSING_COUNT -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰å¿…éœ€çš„ secrets éƒ½å·²æ­£ç¡®é…ç½®ï¼"
            echo ""
            echo "ä½ ç°åœ¨å¯ä»¥è¿è¡Œå®Œæ•´çš„éƒ¨ç½² workflow äº†ã€‚"
          else
            echo "âš ï¸  å‘ç° $MISSING_COUNT ä¸ªæœªé…ç½®çš„ secrets"
            echo ""
            echo "è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥é…ç½® secrets:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "é…ç½®è¯´æ˜æ–‡æ¡£:"
            echo "https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/docs/GITHUB_SECRETS_SETUP.md"
            exit 1
          fi
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}

      - name: Test SSH Connection (Optional)
        if: success()
        run: |
          echo "========================================="
          echo "SSH è¿æ¥æµ‹è¯•"
          echo "========================================="
          echo ""
          echo "æç¤º: æ­¤æ­¥éª¤ä¼šæµ‹è¯• SSH è¿æ¥"
          echo "å¦‚æœå¤±è´¥ï¼Œè¯·æ£€æŸ¥:"
          echo "  1. æœåŠ¡å™¨åœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®"
          echo "  2. SSH ç§é’¥æ˜¯å¦æ­£ç¡®"
          echo "  3. æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®"
          echo ""
          
          # åˆ›å»º SSH ç§é’¥æ–‡ä»¶
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # æµ‹è¯•è¿æ¥
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -p ${{ secrets.REMOTE_PORT || 22 }} \
              ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} \
              "echo 'âœ… SSH è¿æ¥æˆåŠŸï¼'; echo 'æœåŠ¡å™¨ä¿¡æ¯:'; uname -a; echo ''; echo 'ç£ç›˜ç©ºé—´:'; df -h | head -n 5" \
          && echo "" && echo "ğŸ‰ SSH è¿æ¥æµ‹è¯•é€šè¿‡ï¼" \
          || (echo "" && echo "âŒ SSH è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®" && exit 1)
