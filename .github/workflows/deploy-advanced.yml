name: Deploy with PM2 (Advanced)

on:
  push:
    branches:
      - main
      - main-soybean
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # åªåœ¨ä¸»ä»“åº“è¿è¡Œï¼Œfork çš„ PR ä¸è¿è¡Œéƒ¨ç½²
    if: github.event_name == 'workflow_dispatch' || github.repository == 'linlingqin77/Nest-Admin'
    
    strategy:
      matrix:
        node-version: [20]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è°ƒè¯•ä¿¡æ¯
      - name: Debug Information
        run: |
          echo "========================================="
          echo "è°ƒè¯•ä¿¡æ¯"
          echo "========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Is Fork: ${{ github.event.pull_request.head.repo.fork }}"
          echo "========================================="

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # æ„å»ºå‰ç«¯
      - name: Install and build frontend
        run: |
          cd admin-naive-ui
          pnpm install --no-frozen-lockfile || pnpm install
          pnpm run build
        env:
          NODE_ENV: production

      # æ„å»ºåç«¯
      - name: Install and build backend
        run: |
          cd server
          pnpm install --no-frozen-lockfile || pnpm install
          pnpm run prisma:generate
          pnpm run build

      # å‹ç¼©æ„å»ºäº§ç‰©
      - name: Archive production artifacts
        run: |
          mkdir -p deploy-package
          
          # æ‰“åŒ…å‰ç«¯
          cd admin-naive-ui
          tar -czf ../deploy-package/frontend.tar.gz dist/
          cd ..
          
          # æ‰“åŒ…åç«¯
          cd server
          tar -czf ../deploy-package/backend.tar.gz dist/ prisma/ package.json pnpm-lock.yaml ecosystem.config.cjs
          cd ..

      # æ£€æŸ¥å¿…éœ€çš„ secrets
      - name: Check required secrets
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.REMOTE_HOST }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}\n  âŒ REMOTE_HOST"
          else
            echo "âœ… REMOTE_HOST is configured"
          fi
          
          if [ -z "${{ secrets.REMOTE_USER }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}\n  âŒ REMOTE_USER"
          else
            echo "âœ… REMOTE_USER is configured"
          fi
          
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}\n  âŒ SSH_PRIVATE_KEY"
          else
            echo "âœ… SSH_PRIVATE_KEY is configured"
          fi
          
          if [ -z "${{ secrets.REMOTE_FRONTEND_DIR }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}\n  âŒ REMOTE_FRONTEND_DIR"
          else
            echo "âœ… REMOTE_FRONTEND_DIR is configured"
          fi
          
          if [ -z "${{ secrets.REMOTE_BACKEND_DIR }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}\n  âŒ REMOTE_BACKEND_DIR"
          else
            echo "âœ… REMOTE_BACKEND_DIR is configured"
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo ""
            echo "âŒ Error: Missing required GitHub Secrets"
            echo "============================================"
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "ğŸ“– Configuration Guide:"
            echo "   1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Add the missing secrets listed above"
            echo ""
            echo "ğŸ“š Detailed setup instructions:"
            echo "   https://github.com/${{ github.repository }}/blob/main/docs/GITHUB_SECRETS_SETUP.md"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… All required secrets are configured!"
          echo "ğŸš€ Proceeding with deployment..."

      # ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶éƒ¨ç½²
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT || 22 }}
          script: |
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p /tmp/nest-admin-deploy
            
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT || 22 }}
          source: "deploy-package/*"
          target: "/tmp/nest-admin-deploy/"

      - name: Extract and restart services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT || 22 }}
          script: |
            set -e
            
            # è®¾ç½®å˜é‡
            FRONTEND_DIR="${{ secrets.REMOTE_FRONTEND_DIR }}"
            BACKEND_DIR="${{ secrets.REMOTE_BACKEND_DIR }}"
            DEPLOY_TMP="/tmp/nest-admin-deploy/deploy-package"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "$BACKEND_DIR/dist" ]; then
              echo "Backing up current backend..."
              cp -r "$BACKEND_DIR/dist" "$BACKEND_DIR/dist.backup.$(date +%Y%m%d%H%M%S)"
            fi
            
            if [ -d "$FRONTEND_DIR" ]; then
              echo "Backing up current frontend..."
              cp -r "$FRONTEND_DIR" "$FRONTEND_DIR.backup.$(date +%Y%m%d%H%M%S)"
            fi
            
            # è§£å‹å‰ç«¯
            echo "Extracting frontend..."
            mkdir -p "$FRONTEND_DIR"
            tar -xzf "$DEPLOY_TMP/frontend.tar.gz" -C "$FRONTEND_DIR" --strip-components=1
            
            # è§£å‹åç«¯
            echo "Extracting backend..."
            mkdir -p "$BACKEND_DIR"
            tar -xzf "$DEPLOY_TMP/backend.tar.gz" -C "$BACKEND_DIR"
            
            # å®‰è£…ç”Ÿäº§ä¾èµ–
            echo "Installing production dependencies..."
            cd "$BACKEND_DIR"
            pnpm install --prod --no-frozen-lockfile || pnpm install --prod
            
            # ç”Ÿæˆ Prisma Client
            echo "Generating Prisma Client..."
            pnpm run prisma:generate
            
            # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¯é€‰ï¼‰
            # pnpm run prisma:deploy
            
            # ä½¿ç”¨ PM2 é‡å¯åº”ç”¨
            echo "Restarting application with PM2..."
            if pm2 list | grep -q "nest_admin_server"; then
              pm2 reload ecosystem.config.cjs --env production
            else
              pm2 start ecosystem.config.cjs --env production
            fi
            
            # ä¿å­˜ PM2 é…ç½®
            pm2 save
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "Cleaning up..."
            rm -rf /tmp/nest-admin-deploy
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
            cd "$BACKEND_DIR"
            ls -dt dist.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -rf
            
            cd "$(dirname "$FRONTEND_DIR")"
            ls -dt "$(basename "$FRONTEND_DIR").backup."* 2>/dev/null | tail -n +6 | xargs -r rm -rf
            
            echo "Deployment completed successfully!"
            
            # æ˜¾ç¤º PM2 çŠ¶æ€
            pm2 list
            pm2 logs nest_admin_server --lines 20 --nostream

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT || 22 }}
          script: |
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æ£€æŸ¥ PM2 çŠ¶æ€
            if pm2 list | grep -q "nest_admin_server.*online"; then
              echo "âœ… Application is running"
              exit 0
            else
              echo "âŒ Application failed to start"
              pm2 logs nest_admin_server --lines 50 --nostream
              exit 1
            fi
